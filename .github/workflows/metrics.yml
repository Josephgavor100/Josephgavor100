permissions:
  contents: write
  issues: read
  pull-requests: read

name: Metrics
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  github-metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq (binary fallback; avoids apt conflicts)
        run: |
          set -euo pipefail
          if command -v jq >/dev/null 2>&1; then
            echo "jq already installed: $(jq --version)"
          else
            sudo curl -fsSL -o /usr/local/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64
            sudo chmod +x /usr/local/bin/jq
            jq --version
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Verify Docker is available
        run: |
          set -euo pipefail
          if command -v docker >/dev/null 2>&1; then
            echo "docker available: $(docker --version)"
          else
            echo "docker not found on runner. If the action requires a full Docker daemon, consider using a self-hosted runner with Docker installed."
            exit 1
          fi

      - name: Run lowlighter metrics
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.METRICS_ACTION_TOKEN }}
          user: Josephgavor100
          template: classic
          base: header, repositories, activity, languages, stars, isocalendar, followup, habits
          plugin_repositories: yes
          plugin_activity: yes
          plugin_languages: yes
          plugin_stars: yes
          plugin_isocalendar: yes
          plugin_followup: yes
          plugin_habits: yes
          config_timezone: UTC
